<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Control de gastos para ABBY PI ‚ú®</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .animate-fade-in {
      animation: fadeIn 1.2s ease-in-out;
    }
  </style>
</head>
<body class="bg-pink-50 font-sans min-h-screen flex flex-col items-center justify-center">

  <!-- Pantalla de carga inicial -->
  <div id="loadingScreen" class="fixed inset-0 flex flex-col items-center justify-center bg-pink-50 z-50 animate-fade-in">
    <h1 class="text-2xl sm:text-3xl font-bold text-pink-500 mb-4 text-center">
      Control de gastos para ABBY PI ‚ú®
    </h1>
    <p class="text-lg text-pink-400 animate-pulse text-center">
      Esperame princesa, ahorita carga...
    </p>
  </div>

  <!-- Pantalla de login / registro -->
  <div id="authDiv" class="hidden w-full max-w-md bg-white p-6 sm:p-8 rounded-2xl shadow-lg relative mx-4 animate-fade-in">
    <h2 class="text-2xl sm:text-3xl font-bold text-center text-pink-500 mb-6">
      Control de gastos para ABBY PI ‚ú®
    </h2>

    <input type="email" id="email" placeholder="Correo"
      class="w-full p-3 border rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-pink-300">

    <!-- Campo de contrase√±a con bot√≥n para ver -->
    <div class="relative mb-4">
      <input type="password" id="password" placeholder="Contrase√±a"
        class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-300">
      <button type="button" id="togglePassword" 
        class="absolute right-3 top-1/2 -translate-y-1/2 text-pink-400 hover:text-pink-600">
        üëÅÔ∏è
      </button>
    </div>

    <button id="btnRegister"
      class="w-full bg-pink-400 text-white py-2 rounded-full hover:bg-pink-500 transition mb-3">
      Registrarse
    </button>
    <button id="btnLogin"
      class="w-full bg-pink-300 text-white py-2 rounded-full hover:bg-pink-400 transition">
      Iniciar Sesi√≥n
    </button>

    <!-- Mensajes din√°micos -->
    <div id="authMessage" class="text-center mt-4 text-sm font-medium"></div>

    <!-- Footer -->
    <p class="absolute bottom-2 w-full text-center text-pink-400 text-sm">by Se√±or Coraz√≥n</p>
  </div>

  <!-- Dashboard -->
  <div id="appDiv" class="hidden w-full max-w-5xl bg-white p-6 sm:p-8 rounded-2xl shadow-lg relative mx-4 animate-fade-in">
    <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
      <h2 class="text-xl sm:text-2xl font-bold text-pink-500 text-center sm:text-left">
        Control de gastos para ABBY PI ‚ú®
      </h2>
      <button id="btnLogout"
        class="bg-pink-400 text-white px-4 py-2 rounded-full hover:bg-pink-500 transition">
        Cerrar Sesi√≥n
      </button>
    </div>

    <!-- Tarjeta de cr√©dito -->
    <div class="bg-pink-100 p-4 rounded-xl mb-6 shadow-sm">
      <label class="block text-pink-700 font-semibold mb-2 text-center sm:text-left">
        Cr√©dito disponible:
      </label>
      <div class="flex flex-col sm:flex-row gap-3">
        <input type="number" id="creditoInput" placeholder="Monto de cr√©dito"
          class="flex-1 p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-300">
        <button id="btnSetCredito"
          class="bg-pink-400 text-white px-4 py-2 rounded-lg hover:bg-pink-500 transition">
          Actualizar
        </button>
      </div>
    </div>

    <!-- Formulario agregar gasto -->
    <div class="bg-pink-50 p-4 rounded-xl mb-6 shadow-sm">
      <h3 class="text-lg font-semibold text-pink-500 mb-3 text-center sm:text-left">Agregar gasto</h3>
      <div class="flex flex-col md:flex-row gap-3">
        <input type="text" id="concepto" placeholder="Concepto"
          class="flex-1 p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-300">
        <input type="number" id="monto" placeholder="Monto"
          class="w-full md:w-32 p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-300">
        <button id="btnAgregarGasto"
          class="bg-pink-400 text-white px-4 py-2 rounded-lg hover:bg-pink-500 transition">
          Agregar
        </button>
      </div>
    </div>

    <!-- Tabla de gastos -->
    <div class="overflow-x-auto">
      <table class="w-full border rounded-xl overflow-hidden">
        <thead class="bg-pink-100 text-pink-700">
          <tr>
            <th class="p-3 text-left text-sm sm:text-base">Concepto</th>
            <th class="p-3 text-left text-sm sm:text-base">Monto</th>
          </tr>
        </thead>
        <tbody id="tablaGastos" class="divide-y divide-pink-100">
          <!-- Gastos din√°micos -->
        </tbody>
      </table>
    </div>

    <!-- Totales -->
    <div class="mt-6 flex flex-col sm:flex-row justify-between text-base sm:text-lg font-semibold text-pink-600 text-center sm:text-left gap-3">
      <p id="totalGastos">Total de gastos: $0</p>
      <p id="saldoRestante">Saldo restante: $0</p>
    </div>

    <!-- Footer -->
    <p class="absolute bottom-2 left-0 right-0 text-center text-pink-400 text-sm">by Se√±or Coraz√≥n</p>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCy_Chd_afiSy9AZWXx1-eAcICJBlT6R4Q",
    authDomain: "control-gastos-bc0a9.firebaseapp.com",
    projectId: "control-gastos-bc0a9",
    storageBucket: "control-gastos-bc0a9.firebasestorage.app",
    messagingSenderId: "96369707835",
    appId: "1:96369707835:web:7acbffde0169302463051e",
    measurementId: "G-703F29KLH5"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let userId = null;
  let gastos = [];
  let credito = 0;

  const authMessage = document.getElementById("authMessage");

  // --- Pantalla de carga inicial ---
  setTimeout(() => {
    document.getElementById("loadingScreen").style.display = "none";
    if (auth.currentUser) {
      document.getElementById("appDiv").classList.remove("hidden");
    } else {
      document.getElementById("authDiv").classList.remove("hidden");
    }
  }, 5000);

  // --- Alternar visibilidad de contrase√±a ---
  const togglePassword = document.getElementById("togglePassword");
  togglePassword.addEventListener("click", () => {
    const passInput = document.getElementById("password");
    const type = passInput.getAttribute("type") === "password" ? "text" : "password";
    passInput.setAttribute("type", type);
    togglePassword.textContent = type === "password" ? "üëÅÔ∏è" : "üôà";
  });

  // --- Mostrar mensajes din√°micos con loader ---
  function showMessage(message, color = "pink-500", showLoader = false) {
    authMessage.innerHTML = `
      <div class="flex flex-col items-center gap-2">
        ${showLoader ? '<div class="w-6 h-6 border-4 border-pink-300 border-t-pink-500 rounded-full animate-spin"></div>' : ''}
        <span class="text-${color}">${message}</span>
      </div>
    `;
  }

  // --- Registro ---
  async function register() {
    const email = document.getElementById("email").value;
    const pass = document.getElementById("password").value;
    if (!email || !pass) {
      showMessage("Por favor, ingresa correo y contrase√±a", "red-500");
      return;
    }

    try {
      const userCredential = await createUserWithEmailAndPassword(auth, email, pass);
      const uid = userCredential.user.uid;
      await setDoc(doc(db, "usuarios", uid), { credito: 0, gastos: [] });

      showMessage("Registro exitoso üéâ", "green-500", true);
    } catch (e) {
      showMessage("Error en registro: " + e.message, "red-500");
    }
  }

  // --- Login ---
  async function login() {
    const email = document.getElementById("email").value;
    const pass = document.getElementById("password").value;
    if (!email || !pass) {
      showMessage("Por favor, ingresa correo y contrase√±a", "red-500");
      return;
    }

    try {
      showMessage("Iniciando sesi√≥n...", "pink-500", true);
      await signInWithEmailAndPassword(auth, email, pass);
    } catch (e) {
      showMessage("Error en login: " + e.message, "red-500");
    }
  }

  // --- Logout ---
  async function logout() {
    await signOut(auth);
    document.getElementById("appDiv").classList.add("hidden");
    document.getElementById("authDiv").classList.remove("hidden");
  }

  // --- Guardar cr√©dito ---
  async function setCredito() {
    credito = parseFloat(document.getElementById("creditoInput").value) || 0;
    await setDoc(doc(db, "usuarios", userId), { credito, gastos }, { merge: true });
    actualizarVista();
  }

  // --- Agregar gasto ---
  async function agregarGasto() {
    const concepto = document.getElementById("concepto").value;
    const monto = parseFloat(document.getElementById("monto").value) || 0;
    if (!concepto || monto <= 0) return;

    gastos.push({ concepto, monto });
    await setDoc(doc(db, "usuarios", userId), { credito, gastos }, { merge: true });
    document.getElementById("concepto").value = "";
    document.getElementById("monto").value = "";
    actualizarVista();
  }

  // --- Cargar datos ---
  async function cargarDatos() {
    const docRef = doc(db, "usuarios", userId);
    const docSnap = await getDoc(docRef);
    if (!docSnap.exists()) {
      await setDoc(docRef, { credito: 0, gastos: [] });
      credito = 0; gastos = [];
    } else {
      const data = docSnap.data();
      credito = data.credito || 0;
      gastos = data.gastos || [];
    }
    actualizarVista();
  }

  // --- Actualizar la vista ---
  function actualizarVista() {
    const tbody = document.querySelector("#tablaGastos");
    tbody.innerHTML = "";
    let total = 0;
    gastos.forEach(g => {
      total += g.monto;
      tbody.innerHTML += `
        <tr class="hover:bg-pink-50 transition">
          <td class="p-3 text-sm sm:text-base">${g.concepto}</td>
          <td class="p-3 text-sm sm:text-base">$${g.monto.toFixed(2)}</td>
        </tr>`;
    });
    document.getElementById("totalGastos").innerText = "Total de gastos: $" + total.toFixed(2);
    document.getElementById("saldoRestante").innerText = "Saldo restante: $" + (credito - total).toFixed(2);
    document.getElementById("creditoInput").value = credito;
  }

  // --- Manejar cambios de sesi√≥n con delay y loader ---
  onAuthStateChanged(auth, user => {
    if (user) {
      userId = user.uid;
      showMessage("Cargando tu informaci√≥n...", "pink-500", true);

      setTimeout(() => {
        document.getElementById("authDiv").classList.add("hidden");
        document.getElementById("appDiv").classList.remove("hidden");
        cargarDatos();
        authMessage.textContent = ""; // Limpiar mensaje
      }, 2500);
    } else {
      userId = null;
      setTimeout(() => {
        document.getElementById("authDiv").classList.remove("hidden");
        document.getElementById("appDiv").classList.add("hidden");
        authMessage.textContent = "";
      }, 2500);
    }
  });

  // --- Botones ---
  document.getElementById("btnRegister").addEventListener("click", register);
  document.getElementById("btnLogin").addEventListener("click", login);
  document.getElementById("btnLogout").addEventListener("click", logout);
  document.getElementById("btnSetCredito").addEventListener("click", setCredito);
  document.getElementById("btnAgregarGasto").addEventListener("click", agregarGasto);
</script>

</body>
</html>